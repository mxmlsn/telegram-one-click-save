<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Saves</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f0f0f; color: #e0e0e0; min-height: 100vh; }

    /* Auth modal */
    #auth-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .hidden { display: none; }
    .auth-box { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 32px; width: 420px; }
    .auth-box h2 { font-size: 18px; margin-bottom: 24px; color: #fff; }
    .auth-field { margin-bottom: 16px; }
    .auth-field label { display: block; font-size: 12px; color: #888; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .auth-field input { width: 100%; background: #111; border: 1px solid #333; border-radius: 8px; padding: 10px 12px; color: #e0e0e0; font-size: 14px; outline: none; }
    .auth-field input:focus { border-color: #555; }
    .auth-btn { width: 100%; background: #fff; color: #000; border: none; border-radius: 8px; padding: 12px; font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 8px; }
    .auth-btn:hover { background: #e0e0e0; }
  </style>
</head>
<body>

<div id="auth-modal">
  <div class="auth-box">
    <h2>Connect</h2>
    <div class="auth-field">
      <label for="input-notion-token">Notion Token</label>
      <input type="password" id="input-notion-token" placeholder="ntn_..." autocomplete="off">
    </div>
    <div class="auth-field">
      <label for="input-tg-token">Telegram Bot Token</label>
      <input type="password" id="input-tg-token" placeholder="123456:ABC..." autocomplete="off">
    </div>
    <div class="auth-field">
      <label for="input-db-id">Notion Database ID</label>
      <input type="text" id="input-db-id" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" autocomplete="off">
    </div>
    <button class="auth-btn" onclick="saveAuth()">Connect</button>
  </div>
</div>

<div id="app" class="hidden"></div>

<script>
const STORAGE_KEYS = { notion: 'sv_notion_token', tg: 'sv_tg_token', db: 'sv_db_id' };
const NOTION_VERSION = '2022-06-28';

function saveAuth() {
  const notion = document.getElementById('input-notion-token').value.trim();
  const tg = document.getElementById('input-tg-token').value.trim();
  const db = document.getElementById('input-db-id').value.trim();
  if (!notion || !tg || !db) return alert('Fill all fields');
  localStorage.setItem(STORAGE_KEYS.notion, notion);
  localStorage.setItem(STORAGE_KEYS.tg, tg);
  localStorage.setItem(STORAGE_KEYS.db, db);
  document.getElementById('auth-modal').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  init();
}

function getAuth() {
  return {
    notion: localStorage.getItem(STORAGE_KEYS.notion),
    tg: localStorage.getItem(STORAGE_KEYS.tg),
    db: localStorage.getItem(STORAGE_KEYS.db)
  };
}

window.addEventListener('DOMContentLoaded', () => {
  const { notion, tg, db } = getAuth();
  if (notion && tg && db) {
    document.getElementById('auth-modal').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    init();
  }
});

async function fetchNotion(notionToken, dbId) {
  let results = [];
  let cursor = undefined;
  let page = 0;
  do {
    const body = { page_size: 100, sorts: [{ property: 'Date', direction: 'descending' }] };
    if (cursor) body.start_cursor = cursor;
    const res = await fetch(`https://api.notion.com/v1/databases/${dbId}/query`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${notionToken}`,
        'Notion-Version': NOTION_VERSION,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    if (!res.ok) {
      let msg = 'Notion fetch failed';
      try { msg = (await res.json()).message || msg; } catch {}
      throw new Error(`${res.status}: ${msg}`);
    }
    const data = await res.json();
    results = results.concat(data.results);
    cursor = data.has_more ? data.next_cursor : undefined;
    page++;
  } while (cursor && page < 20);
  return results;
}

function parseItem(page) {
  const p = page.properties;
  return {
    id: page.id,
    url: p['URL']?.title?.[0]?.text?.content || '',
    type: p['Type']?.select?.name || 'link',
    tag: p['Tag']?.select?.name || '',
    content: p['Content']?.rich_text?.[0]?.text?.content || '',
    fileId: p['File ID']?.rich_text?.[0]?.text?.content || '',
    sourceUrl: p['Source URL']?.url || '',
    date: p['Date']?.date?.start || ''
  };
}

async function init() {
  const { notion, tg, db } = getAuth();
  document.getElementById('app').innerHTML = '<p style="padding:40px;color:#666">Fetching...</p>';
  try {
    const pages = await fetchNotion(notion, db);
    const items = pages.map(parseItem);
    console.log('[Saves] loaded', items.length, 'items');
    const imageMap = await resolveAllImages(items, tg);
    window.__imageMap = imageMap;
    renderApp(items, imageMap);
  } catch (e) {
    const errEl = document.createElement('p');
    errEl.style.cssText = 'padding:40px;color:#f66';
    errEl.textContent = 'Error: ' + e.message;
    document.getElementById('app').replaceChildren(errEl);
  }
}

async function resolveFileId(tgToken, fileId) {
  if (!fileId) return null;
  try {
    const res = await fetch(`https://api.telegram.org/bot${tgToken}/getFile?file_id=${fileId}`);
    const data = await res.json();
    if (!data.ok) return null;
    return `https://api.telegram.org/file/bot${tgToken}/${data.result.file_path}`;
  } catch { return null; }
}

async function resolveAllImages(items, tgToken) {
  const withImages = items.filter(i => i.fileId);
  const urls = await Promise.all(withImages.map(i => resolveFileId(tgToken, i.fileId)));
  const map = {};
  withImages.forEach((item, idx) => { if (urls[idx]) map[item.fileId] = urls[idx]; });
  return map; // fileId â†’ imageUrl
}

function renderApp(items, imageMap) {
  window.__allItems = items;
  window.__imageMap = imageMap;
  document.getElementById('app').innerHTML = `<p style="padding:40px;color:#666">${items.length} items loaded, ${Object.keys(imageMap).length} images resolved</p>`;
}
</script>
</body>
</html>
